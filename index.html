<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seismic Data Visualization with STFT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.0.0/math.min.js"></script> <!-- 加载 math.js -->
</head>
<body>
    <h1>Seismic Data Visualization with STFT</h1>
    <input type="file" id="fileInput" accept=".csv">
    <button onclick="processCSV()">Process CSV</button>
    <p id="statusMessage"></p> <!-- 狀態提示 -->
    <br><br>
    <img id="stftImage" alt="STFT Image" /> <!-- 用來顯示 STFT 圖像 -->

    <script>
        let originalData = []; // 保存原始波形數據

        // 处理 CSV 文件
        function processCSV() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files.length) {
                alert("Please upload a CSV file.");
                return;
            }

            const csvFile = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                const csvData = event.target.result;
                originalData = parseCSV(csvData);
                applySTFT(originalData);
            };
            reader.readAsText(csvFile);
        }

        // 将 CSV 文件解析成數字數據
        function parseCSV(csvData) {
            const rows = csvData.split('\n');
            const data = rows.map(row => {
                const values = row.split(',');
                return parseFloat(values[2]); // 提取第三列 velocity(m/s)
            }).filter(value => !isNaN(value)); // 過濾掉無效值
            return data;
        }

        // STFT 計算函數
        function applySTFT(data) {
            document.getElementById('statusMessage').textContent = 'Processing STFT...'; // 顯示提示信息

            const windowSize = 256; // 每個STFT窗口的大小
            const hopSize = 128; // 窗口之間的重疊大小
            const sampleRate = 1; // 假設為 1 Hz (可根據實際情況設置)

            const stftData = [];

            for (let start = 0; start + windowSize <= data.length; start += hopSize) {
                const segment = data.slice(start, start + windowSize);
                const windowedSegment = applyWindow(segment);
                const fftResult = applyFFT(windowedSegment);
                stftData.push(fftResult);
            }

            drawSTFT(stftData, windowSize, hopSize, sampleRate);
        }

        // 使用漢明窗進行加窗處理
        function applyWindow(segment) {
            const hammingWindow = new Float64Array(segment.length);
            for (let i = 0; i < segment.length; i++) {
                hammingWindow[i] = 0.54 - 0.46 * Math.cos((2 * Math.PI * i) / (segment.length - 1));
            }
            return segment.map((value, index) => value * hammingWindow[index]);
        }

        // 使用 math.js 計算 FFT
        function applyFFT(segment) {
            const complexSignal = segment.map(value => math.complex(value, 0)); // 將實數信號轉換為復數
            const fftResult = math.fft(complexSignal);
            return fftResult.map(c => math.abs(c)); // 返回 FFT 結果的幅度
        }

        // 畫 STFT 結果並將其顯示為靜態圖像
        function drawSTFT(stftData, windowSize, hopSize, sampleRate) {
            const canvas = document.createElement('canvas');
            const canvasWidth = stftData.length;
            const canvasHeight = windowSize / 2;
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            const ctx = canvas.getContext('2d');

            // 獲取 STFT 的最大幅度，用來做幅度歸一化
            const maxAmplitude = Math.max(...stftData.flat());

            // 繪製 STFT 結果
            for (let t = 0; t < stftData.length; t++) {
                for (let f = 0; f < canvasHeight; f++) {
                    const magnitude = stftData[t][f] / maxAmplitude;
                    const colorValue = Math.floor(magnitude * 255);
                    ctx.fillStyle = `rgb(${colorValue}, ${colorValue}, ${colorValue})`;
                    ctx.fillRect(t, canvasHeight - f, 1, 1); // 顯示為灰度圖像
                }
            }

            // 將 Canvas 轉換為圖像並顯示
            const img = document.getElementById('stftImage');
            img.src = canvas.toDataURL();
            document.getElementById('statusMessage').textContent = 'STFT completed!';
        }
    </script>
</body>
</html>
